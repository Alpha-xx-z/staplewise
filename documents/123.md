# 🚀 StapleWise Production Deployment Guide

## 📋 Overview
This guide will help you deploy your StapleWise application to production using your VPS and Vercel. We'll deploy the backend to your VPS and the frontend to Vercel.

## 🎯 Deployment Strategy
- **Full Stack (Frontend + Backend)**: Deploy to VPS with Docker
- **Database**: MySQL container or external database
- **File Storage**: MinIO container or external storage
- **Web Server**: Nginx reverse proxy with SSL
- **Process Management**: Docker Compose for orchestration

---

## 📁 Project Directory Structure

### 🏠 **Local Development Structure**
```
SW/
├── 📁 src/                          # Frontend source code
│   ├── 📁 components/               # React components
│   │   ├── 📁 common/              # Shared components
│   │   │   ├── FloatingPopup.tsx   # Buy/Sell form
│   │   │   ├── Header.tsx          # Navigation header
│   │   │   ├── LoginModal.tsx      # Authentication modal
│   │   │   └── ProtectedRoute.tsx  # Route protection
│   │   └── ...
│   ├── 📁 pages/                   # Page components
│   │   ├── 📁 dashboards/          # Dashboard pages
│   │   │   ├── AdminDashboard.tsx  # Admin panel
│   │   │   └── SalesDashboard.tsx  # Sales dashboard
│   │   ├── 📁 seller/              # Seller pages
│   │   │   ├── SellerPortal.tsx    # Seller main page
│   │   │   ├── ListProduct.tsx     # Product listing
│   │   │   └── Orders.tsx          # Order management
│   │   ├── Home.tsx                # Landing page
│   │   ├── Products.tsx            # Product catalog
│   │   └── ProductDetail.tsx       # Product details
│   ├── 📁 lib/                     # Utility libraries
│   │   ├── apiClient.ts            # API client
│   │   ├── auth.ts                 # Authentication
│   │   ├── minio.ts                # File storage
│   │   └── prisma.ts               # Database client
│   ├── 📁 contexts/                # React contexts
│   │   └── AuthContext.tsx         # Authentication context
│   ├── 📁 types/                   # TypeScript types
│   │   └── index.ts                # Type definitions
│   ├── App.tsx                     # Main app component
│   ├── main.tsx                    # App entry point
│   └── index.css                   # Global styles
├── 📁 prisma/                      # Database schema & migrations
│   ├── schema.prisma               # Database schema
│   ├── dev.db                      # Development database
│   └── seed.ts                     # Database seeding
├── 📁 public/                      # Static assets
├── server.ts                       # Backend server (Express)
├── package.json                    # Dependencies & scripts
├── vite.config.ts                  # Vite configuration
├── tailwind.config.js              # Tailwind CSS config
├── tsconfig.json                   # TypeScript config
└── .env                            # Environment variables
```

### 🚀 **Production VPS Structure**
```
/var/www/staplewise/                # Application root
├── 📁 src/                         # Frontend source (for building)
├── 📁 prisma/                      # Database files
├── 📁 logs/                        # Application logs
│   ├── pm2-error.log              # PM2 error logs
│   ├── pm2-out.log                # PM2 output logs
│   └── pm2-combined.log           # Combined logs
├── 📁 backup/                      # Database backups
├── server.ts                       # Backend server
├── ecosystem.config.js             # PM2 configuration
├── package.json                    # Dependencies
├── .env                           # Production environment
└── deploy.sh                      # Deployment script
```

### 🌐 **Nginx Configuration Structure**
```
/etc/nginx/
├── sites-available/
│   └── staplewise                 # Nginx site config
├── sites-enabled/
│   └── staplewise -> ../sites-available/staplewise
├── ssl/                           # SSL certificates
│   ├── your-domain.com.crt
│   └── your-domain.com.key
└── logs/
    ├── access.log                 # Access logs
    └── error.log                  # Error logs
```

### 🗄️ **Database Structure**
```
MySQL Database: Staplewise
├── 📋 users                       # User accounts
├── 📋 products                    # Product listings
├── 📋 orders                      # Order management
├── 📋 order_items                 # Order line items
├── 📋 queries                     # Product queries
├── 📋 company_details             # Company information
└── 📋 migrations                  # Schema migrations
```

### 📦 **MinIO Storage Structure**
```
MinIO Buckets:
├── 📁 staplewise-images/          # Product images
│   ├── products/                  # Product photos
│   ├── profiles/                  # User profile pictures
│   └── documents/                 # General images
└── 📁 staplewise-documents/       # Business documents
    ├── invoices/                  # Invoice PDFs
    ├── contracts/                 # Contract documents
    └── certificates/              # Quality certificates
```

### 🔧 **System Service Structure**
```
/etc/systemd/system/
├── minio.service                  # MinIO service
└── nginx.service                  # Nginx service

/var/log/
├── 📁 pm2/                        # PM2 logs
│   ├── staplewise-error.log
│   ├── staplewise-out.log
│   └── staplewise-combined.log
└── 📁 nginx/                      # Nginx logs
    ├── access.log
    └── error.log
```

### 🐳 **Docker Structure (Optional)**
```
docker-compose.yml                 # Container orchestration
├── 📦 backend                     # Node.js application
├── 📦 mysql                       # Database container
├── 📦 minio                       # File storage container
└── 📦 nginx                       # Web server container

📁 nginx/
├── nginx.conf                     # Nginx configuration
├── sites-available/               # Site configurations
└── ssl/                          # SSL certificates

📁 mysql/
└── init/                         # Database initialization
```

### 🔄 **CI/CD Structure**
```
.github/
└── workflows/
    └── deploy-backend.yml         # GitHub Actions workflow

📁 scripts/
├── deploy.sh                      # VPS deployment script
├── backup.sh                      # Database backup script
└── health-check.sh               # Health monitoring script
```

### 📊 **Monitoring & Logs Structure**
```
/var/log/
├── 📁 application/                # Application logs
│   ├── access.log                # API access logs
│   ├── error.log                 # Error logs
│   └── combined.log              # Combined logs
├── 📁 database/                   # Database logs
│   └── mysql.log                 # MySQL logs
├── 📁 minio/                      # MinIO logs
│   └── minio.log                 # MinIO access logs
└── 📁 nginx/                      # Nginx logs
    ├── access.log                # Web access logs
    └── error.log                 # Web error logs
```

### 🔐 **Security Structure**
```
/etc/ssl/
├── 📁 certs/                      # SSL certificates
│   ├── your-domain.com.crt
│   └── your-domain.com.key
└── 📁 private/                    # Private keys

/etc/letsencrypt/
├── 📁 live/                       # Live certificates
│   └── your-domain.com/
└── 📁 archive/                    # Certificate archive
    └── your-domain.com/
```

### 📈 **Backup Structure**
```
/backup/
├── 📁 database/                   # Database backups
│   ├── staplewise_20241201_020000.sql
│   ├── staplewise_20241202_020000.sql
│   └── ...
├── 📁 application/                # Application backups
│   ├── staplewise_app_20241201_020000.tar.gz
│   ├── staplewise_app_20241202_020000.tar.gz
│   └── ...
└── 📁 minio/                      # File storage backups
    ├── images_backup_20241201.tar.gz
    └── documents_backup_20241201.tar.gz
```

---

## 🔧 Step 1: Prepare Your VPS

### 1.1 Connect to Your VPS
```bash
ssh root@your-vps-ip
```

### 1.2 Update System
```bash
apt update && apt upgrade -y
```

### 1.3 Install Docker & Docker Compose
```bash
# Install Docker
sudo apt install -y docker.io docker-compose

# Enable Docker service
sudo systemctl enable docker
sudo systemctl start docker

# Add user to docker group (replace $USER with your username)
sudo usermod -aG docker $USER

# Install Nginx (for reverse proxy)
sudo apt install nginx -y

# Install Certbot for SSL
sudo apt install certbot python3-certbot-nginx -y

# Install Git
sudo apt install git -y
```

### 1.4 Reboot to Apply Docker Permissions
```bash
# Reboot or logout/login to apply Docker group permissions
reboot
```

### 1.5 Verify Installations
```bash
docker --version      # Should show Docker version
docker-compose --version  # Should show Docker Compose version
nginx -v              # Should show nginx version
```

---

## 🗄️ Step 2: Database Setup

### 2.1 Install MySQL (if not already installed)
```bash
apt install mysql-server -y
mysql_secure_installation
```

### 2.2 Create Database and User
```bash
mysql -u root -p
```

```sql
CREATE DATABASE Staplewise;
CREATE USER 'staplewise_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON Staplewise.* TO 'staplewise_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2.3 Update Database Configuration
Update your `.env` file on VPS:
```env
DATABASE_URL="mysql://staplewise_user:your_secure_password@localhost:3306/Staplewise"
```

---

## 📁 Step 3: Deploy Application with Docker

### 3.1 Clone Repository
```bash
cd /var/www
git clone https://github.com/your-username/staplewise.git
cd staplewise
```

### 3.2 Create Production Environment File
```bash
nano .env
```

Add your production environment variables:
```env
# Database Configuration (use external database or uncomment MySQL in docker-compose.yml)
DATABASE_URL="mysql://staplewise_user:your_secure_password@localhost:3306/Staplewise"

# JWT Configuration
JWT_SECRET="your-super-secure-jwt-secret-key-change-this-in-production"

# MinIO Configuration (use external MinIO or uncomment in docker-compose.yml)
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=your_minio_access_key
MINIO_SECRET_KEY=your_minio_secret_key
MINIO_USE_SSL=false
MINIO_BUCKET_DOCUMENTS=staplewise-documents
MINIO_BUCKET_IMAGES=staplewise-images

# Email Configuration
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_gmail_app_password

# Application Configuration
NODE_ENV=production
PORT=3000

# Frontend URL
FRONTEND_URL=https://your-domain.com
```

### 3.3 Build & Run Docker Application
```bash
# Build the Docker image
docker compose build

# Start the application
docker compose up -d

# Check if containers are running
docker compose ps

# View logs
docker compose logs -f app
```

### 3.4 Verify Application is Running
```bash
# Test the application
curl http://localhost:3000/api/health

# Check container status
docker ps
```

---

## 🌐 Step 4: Configure Nginx

### 4.1 Create Nginx Configuration
```bash
nano /etc/nginx/sites-available/staplewise
```

Add this configuration:
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Proxy all requests to Docker container
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Health check
    location /health {
        proxy_pass http://localhost:3000/api/health;
    }
}
```

### 4.2 Enable Site
```bash
ln -s /etc/nginx/sites-available/staplewise /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx
```

---

## 🔒 Step 5: SSL Certificate

### 5.1 Get SSL Certificate
```bash
certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 5.2 Auto-renewal
```bash
crontab -e
```

Add this line:
```
0 12 * * * /usr/bin/certbot renew --quiet
```

---

## 🚀 Step 6: Deploy Frontend to Vercel

### 6.1 Prepare Frontend for Production

Update `src/lib/apiClient.ts`:
```typescript
export class ApiClient {
  private static baseUrl = process.env.NODE_ENV === 'production' 
    ? 'https://your-domain.com/api' 
    : 'http://localhost:3000/api';
  // ... rest of the code
}
```

### 6.2 Create Vercel Configuration
Create `vercel.json`:
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ],
  "env": {
    "VITE_API_URL": "https://your-domain.com/api"
  }
}
```

### 6.3 Deploy to Vercel
```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy
vercel --prod
```

---

## 🔧 Step 7: Environment Variables Setup

### 7.1 Vercel Environment Variables
In Vercel dashboard, add these environment variables:
```
VITE_API_URL=https://your-domain.com/api
```

### 7.2 Update Frontend API Client
Update `src/lib/apiClient.ts`:
```typescript
export class ApiClient {
  private static baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';
  // ... rest of the code
}
```

---

## 🧪 Step 8: Testing Production

### 8.1 Test Application
```bash
# Test health endpoint
curl http://your-domain.com/api/health

# Test API endpoints
curl http://your-domain.com/api/auth/login

# Test frontend
curl http://your-domain.com
```

### 8.2 Test Docker Container
```bash
# Check container logs
docker compose logs app

# Restart container if needed
docker compose restart app

# Check container status
docker compose ps
```

### 8.3 Test Frontend & Backend Integration
- Visit your domain: `http://your-domain.com`
- Test login/registration
- Test file uploads
- Test email functionality
- Check browser dev tools → Network tab for API calls

---

## 🔄 Step 9: CI/CD Setup

### 9.1 GitHub Actions for Backend
Create `.github/workflows/deploy-backend.yml`:
```yaml
name: Deploy Backend to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /var/www/staplewise
          git pull origin main
          npm install
          pm2 restart staplewise-backend
```

### 9.2 GitHub Secrets
Add these secrets to your GitHub repository:
- `VPS_HOST`: Your VPS IP
- `VPS_USERNAME`: root
- `VPS_SSH_KEY`: Your SSH private key

---

## 📊 Step 10: Monitoring & Maintenance

### 10.1 Docker Monitoring
```bash
# View container logs
docker compose logs -f app

# Monitor container resources
docker stats

# View container status
docker compose ps

# Check container health
docker compose exec app curl http://localhost:3000/api/health
```

### 10.2 Nginx Logs
```bash
# Access logs
tail -f /var/log/nginx/access.log

# Error logs
tail -f /var/log/nginx/error.log
```

### 10.3 Application Management
```bash
# Restart application
docker compose restart app

# Update application
git pull
docker compose build
docker compose up -d

# View application logs
docker compose logs app --tail=100
```

### 10.4 Database Backup
Create backup script `/root/backup.sh`:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"
mkdir -p $BACKUP_DIR

# Database backup (using .my.cnf for credentials)
mysqldump Staplewise > $BACKUP_DIR/staplewise_db_$DATE.sql

# Application backup
tar -czf $BACKUP_DIR/staplewise_app_$DATE.tar.gz /var/www/staplewise

# Keep only last 7 days of backups
find $BACKUP_DIR -name "staplewise_*" -mtime +7 -delete

echo "Backup completed: $DATE"
```

Create MySQL credentials file for automated backups:
```bash
# Create secure credentials file
cat > /root/.my.cnf << 'EOF'
[client]
user=staplewise_user
password=your_secure_mysql_password
EOF

# Secure the credentials file
chmod 600 /root/.my.cnf
```

Make backup script executable:
```bash
chmod +x /root/backup.sh
```

Add to crontab:
```bash
0 2 * * * /root/backup.sh
```

---

## 🐳 Docker Alternative (Optional)

If you prefer Docker, here's the setup:

### Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npx", "tsx", "server.ts"]
```

### docker-compose.yml
```yaml
version: '3.8'
services:
  backend:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    depends_on:
      - mysql
      - minio

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: your_root_password
      MYSQL_DATABASE: Staplewise
      MYSQL_USER: staplewise_user
      MYSQL_PASSWORD: your_password
    volumes:
      - mysql_data:/var/lib/mysql

  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: your_minio_user
      MINIO_ROOT_PASSWORD: your_minio_password
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

volumes:
  mysql_data:
  minio_data:
```

---

## 🔍 Troubleshooting

### Common Issues:

1. **Port 3000 not accessible**
   ```bash
   # Check if container is running
   docker compose ps
   
   # Check container logs
   docker compose logs app
   
   # Check firewall
   ufw status
   ufw allow 3000
   ```

2. **Docker container not starting**
   ```bash
   # Check container logs
   docker compose logs app
   
   # Rebuild and restart
   docker compose down
   docker compose build --no-cache
   docker compose up -d
   ```

3. **Nginx 502 error**
   ```bash
   # Check if container is running
   docker compose ps
   
   # Check nginx error logs
   tail -f /var/log/nginx/error.log
   
   # Test container directly
   curl http://localhost:3000/api/health
   ```

4. **Database connection issues**
   ```bash
   # Test MySQL connection
   mysql -u staplewise_user -p Staplewise
   
   # Check MySQL status
   systemctl status mysql
   
   # Check container environment
   docker compose exec app env | grep DATABASE
   ```

5. **Application not building**
   ```bash
   # Check Docker build logs
   docker compose build --no-cache
   
   # Check for missing files
   ls -la
   
   # Verify .env file exists
   cat .env
   ```

---

## 📈 Performance Optimization

### 1. Enable Gzip Compression
Add to Nginx config:
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

### 2. Enable Caching
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. Database Optimization
```sql
-- Add indexes for better performance
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_product_seller ON products(sellerId);
CREATE INDEX idx_order_buyer ON orders(buyerId);
```

---

## 🎉 Success Checklist

- [ ] Docker and Docker Compose installed on VPS
- [ ] Application container running successfully
- [ ] Frontend and backend working together
- [ ] Database connected and working
- [ ] File storage working (MinIO or external)
- [ ] Nginx reverse proxy configured
- [ ] SSL certificate installed
- [ ] Email functionality working
- [ ] Domain pointing to correct server
- [ ] Monitoring and logging setup
- [ ] Backup system configured
- [ ] CI/CD pipeline working (optional)

---

## 📞 Support

If you encounter any issues:
1. Check the logs: `pm2 logs` and `nginx error logs`
2. Verify environment variables
3. Test individual components
4. Check firewall and port configurations

Your StapleWise application is now production-ready! 🚀 