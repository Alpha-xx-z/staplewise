# ðŸš€ StapleWise Production Deployment Guide

## ðŸ“‹ Overview
This guide will help you deploy your StapleWise application to production using your VPS and Vercel. We'll deploy the backend to your VPS and the frontend to Vercel.

## ðŸŽ¯ Deployment Strategy
- **Full Stack (Frontend + Backend)**: Deploy to VPS with Docker
- **Database**: MySQL container or external database
- **File Storage**: MinIO container or external storage
- **Web Server**: Nginx reverse proxy with SSL
- **Process Management**: Docker Compose for orchestration

---

## ðŸ“ Project Directory Structure

### ðŸ  **Local Development Structure**
```
SW/
â”œâ”€â”€ ðŸ“ src/                          # Frontend source code
â”‚   â”œâ”€â”€ ðŸ“ components/               # React components
â”‚   â”‚   â”œâ”€â”€ ðŸ“ common/              # Shared components
â”‚   â”‚   â”‚   â”œâ”€â”€ FloatingPopup.tsx   # Buy/Sell form
â”‚   â”‚   â”‚   â”œâ”€â”€ Header.tsx          # Navigation header
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginModal.tsx      # Authentication modal
â”‚   â”‚   â”‚   â””â”€â”€ ProtectedRoute.tsx  # Route protection
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ ðŸ“ pages/                   # Page components
â”‚   â”‚   â”œâ”€â”€ ðŸ“ dashboards/          # Dashboard pages
â”‚   â”‚   â”‚   â”œâ”€â”€ AdminDashboard.tsx  # Admin panel
â”‚   â”‚   â”‚   â””â”€â”€ SalesDashboard.tsx  # Sales dashboard
â”‚   â”‚   â”œâ”€â”€ ðŸ“ seller/              # Seller pages
â”‚   â”‚   â”‚   â”œâ”€â”€ SellerPortal.tsx    # Seller main page
â”‚   â”‚   â”‚   â”œâ”€â”€ ListProduct.tsx     # Product listing
â”‚   â”‚   â”‚   â””â”€â”€ Orders.tsx          # Order management
â”‚   â”‚   â”œâ”€â”€ Home.tsx                # Landing page
â”‚   â”‚   â”œâ”€â”€ Products.tsx            # Product catalog
â”‚   â”‚   â””â”€â”€ ProductDetail.tsx       # Product details
â”‚   â”œâ”€â”€ ðŸ“ lib/                     # Utility libraries
â”‚   â”‚   â”œâ”€â”€ apiClient.ts            # API client
â”‚   â”‚   â”œâ”€â”€ auth.ts                 # Authentication
â”‚   â”‚   â”œâ”€â”€ minio.ts                # File storage
â”‚   â”‚   â””â”€â”€ prisma.ts               # Database client
â”‚   â”œâ”€â”€ ðŸ“ contexts/                # React contexts
â”‚   â”‚   â””â”€â”€ AuthContext.tsx         # Authentication context
â”‚   â”œâ”€â”€ ðŸ“ types/                   # TypeScript types
â”‚   â”‚   â””â”€â”€ index.ts                # Type definitions
â”‚   â”œâ”€â”€ App.tsx                     # Main app component
â”‚   â”œâ”€â”€ main.tsx                    # App entry point
â”‚   â””â”€â”€ index.css                   # Global styles
â”œâ”€â”€ ðŸ“ prisma/                      # Database schema & migrations
â”‚   â”œâ”€â”€ schema.prisma               # Database schema
â”‚   â”œâ”€â”€ dev.db                      # Development database
â”‚   â””â”€â”€ seed.ts                     # Database seeding
â”œâ”€â”€ ðŸ“ public/                      # Static assets
â”œâ”€â”€ server.ts                       # Backend server (Express)
â”œâ”€â”€ package.json                    # Dependencies & scripts
â”œâ”€â”€ vite.config.ts                  # Vite configuration
â”œâ”€â”€ tailwind.config.js              # Tailwind CSS config
â”œâ”€â”€ tsconfig.json                   # TypeScript config
â””â”€â”€ .env                            # Environment variables
```

### ðŸš€ **Production VPS Structure**
```
/var/www/staplewise/                # Application root
â”œâ”€â”€ ðŸ“ src/                         # Frontend source (for building)
â”œâ”€â”€ ðŸ“ prisma/                      # Database files
â”œâ”€â”€ ðŸ“ logs/                        # Application logs
â”‚   â”œâ”€â”€ pm2-error.log              # PM2 error logs
â”‚   â”œâ”€â”€ pm2-out.log                # PM2 output logs
â”‚   â””â”€â”€ pm2-combined.log           # Combined logs
â”œâ”€â”€ ðŸ“ backup/                      # Database backups
â”œâ”€â”€ server.ts                       # Backend server
â”œâ”€â”€ ecosystem.config.js             # PM2 configuration
â”œâ”€â”€ package.json                    # Dependencies
â”œâ”€â”€ .env                           # Production environment
â””â”€â”€ deploy.sh                      # Deployment script
```

### ðŸŒ **Nginx Configuration Structure**
```
/etc/nginx/
â”œâ”€â”€ sites-available/
â”‚   â””â”€â”€ staplewise                 # Nginx site config
â”œâ”€â”€ sites-enabled/
â”‚   â””â”€â”€ staplewise -> ../sites-available/staplewise
â”œâ”€â”€ ssl/                           # SSL certificates
â”‚   â”œâ”€â”€ your-domain.com.crt
â”‚   â””â”€â”€ your-domain.com.key
â””â”€â”€ logs/
    â”œâ”€â”€ access.log                 # Access logs
    â””â”€â”€ error.log                  # Error logs
```

### ðŸ—„ï¸ **Database Structure**
```
MySQL Database: Staplewise
â”œâ”€â”€ ðŸ“‹ users                       # User accounts
â”œâ”€â”€ ðŸ“‹ products                    # Product listings
â”œâ”€â”€ ðŸ“‹ orders                      # Order management
â”œâ”€â”€ ðŸ“‹ order_items                 # Order line items
â”œâ”€â”€ ðŸ“‹ queries                     # Product queries
â”œâ”€â”€ ðŸ“‹ company_details             # Company information
â””â”€â”€ ðŸ“‹ migrations                  # Schema migrations
```

### ðŸ“¦ **MinIO Storage Structure**
```
MinIO Buckets:
â”œâ”€â”€ ðŸ“ staplewise-images/          # Product images
â”‚   â”œâ”€â”€ products/                  # Product photos
â”‚   â”œâ”€â”€ profiles/                  # User profile pictures
â”‚   â””â”€â”€ documents/                 # General images
â””â”€â”€ ðŸ“ staplewise-documents/       # Business documents
    â”œâ”€â”€ invoices/                  # Invoice PDFs
    â”œâ”€â”€ contracts/                 # Contract documents
    â””â”€â”€ certificates/              # Quality certificates
```

### ðŸ”§ **System Service Structure**
```
/etc/systemd/system/
â”œâ”€â”€ minio.service                  # MinIO service
â””â”€â”€ nginx.service                  # Nginx service

/var/log/
â”œâ”€â”€ ðŸ“ pm2/                        # PM2 logs
â”‚   â”œâ”€â”€ staplewise-error.log
â”‚   â”œâ”€â”€ staplewise-out.log
â”‚   â””â”€â”€ staplewise-combined.log
â””â”€â”€ ðŸ“ nginx/                      # Nginx logs
    â”œâ”€â”€ access.log
    â””â”€â”€ error.log
```

### ðŸ³ **Docker Structure (Optional)**
```
docker-compose.yml                 # Container orchestration
â”œâ”€â”€ ðŸ“¦ backend                     # Node.js application
â”œâ”€â”€ ðŸ“¦ mysql                       # Database container
â”œâ”€â”€ ðŸ“¦ minio                       # File storage container
â””â”€â”€ ðŸ“¦ nginx                       # Web server container

ðŸ“ nginx/
â”œâ”€â”€ nginx.conf                     # Nginx configuration
â”œâ”€â”€ sites-available/               # Site configurations
â””â”€â”€ ssl/                          # SSL certificates

ðŸ“ mysql/
â””â”€â”€ init/                         # Database initialization
```

### ðŸ”„ **CI/CD Structure**
```
.github/
â””â”€â”€ workflows/
    â””â”€â”€ deploy-backend.yml         # GitHub Actions workflow

ðŸ“ scripts/
â”œâ”€â”€ deploy.sh                      # VPS deployment script
â”œâ”€â”€ backup.sh                      # Database backup script
â””â”€â”€ health-check.sh               # Health monitoring script
```

### ðŸ“Š **Monitoring & Logs Structure**
```
/var/log/
â”œâ”€â”€ ðŸ“ application/                # Application logs
â”‚   â”œâ”€â”€ access.log                # API access logs
â”‚   â”œâ”€â”€ error.log                 # Error logs
â”‚   â””â”€â”€ combined.log              # Combined logs
â”œâ”€â”€ ðŸ“ database/                   # Database logs
â”‚   â””â”€â”€ mysql.log                 # MySQL logs
â”œâ”€â”€ ðŸ“ minio/                      # MinIO logs
â”‚   â””â”€â”€ minio.log                 # MinIO access logs
â””â”€â”€ ðŸ“ nginx/                      # Nginx logs
    â”œâ”€â”€ access.log                # Web access logs
    â””â”€â”€ error.log                 # Web error logs
```

### ðŸ” **Security Structure**
```
/etc/ssl/
â”œâ”€â”€ ðŸ“ certs/                      # SSL certificates
â”‚   â”œâ”€â”€ your-domain.com.crt
â”‚   â””â”€â”€ your-domain.com.key
â””â”€â”€ ðŸ“ private/                    # Private keys

/etc/letsencrypt/
â”œâ”€â”€ ðŸ“ live/                       # Live certificates
â”‚   â””â”€â”€ your-domain.com/
â””â”€â”€ ðŸ“ archive/                    # Certificate archive
    â””â”€â”€ your-domain.com/
```

### ðŸ“ˆ **Backup Structure**
```
/backup/
â”œâ”€â”€ ðŸ“ database/                   # Database backups
â”‚   â”œâ”€â”€ staplewise_20241201_020000.sql
â”‚   â”œâ”€â”€ staplewise_20241202_020000.sql
â”‚   â””â”€â”€ ...
â”œâ”€â”€ ðŸ“ application/                # Application backups
â”‚   â”œâ”€â”€ staplewise_app_20241201_020000.tar.gz
â”‚   â”œâ”€â”€ staplewise_app_20241202_020000.tar.gz
â”‚   â””â”€â”€ ...
â””â”€â”€ ðŸ“ minio/                      # File storage backups
    â”œâ”€â”€ images_backup_20241201.tar.gz
    â””â”€â”€ documents_backup_20241201.tar.gz
```

---

## ðŸ”§ Step 1: Prepare Your VPS

### 1.1 Connect to Your VPS
```bash
ssh root@your-vps-ip
```

### 1.2 Update System
```bash
apt update && apt upgrade -y
```

### 1.3 Install Docker & Docker Compose
```bash
# Install Docker
sudo apt install -y docker.io docker-compose

# Enable Docker service
sudo systemctl enable docker
sudo systemctl start docker

# Add user to docker group (replace $USER with your username)
sudo usermod -aG docker $USER

# Install Nginx (for reverse proxy)
sudo apt install nginx -y

# Install Certbot for SSL
sudo apt install certbot python3-certbot-nginx -y

# Install Git
sudo apt install git -y
```

### 1.4 Reboot to Apply Docker Permissions
```bash
# Reboot or logout/login to apply Docker group permissions
reboot
```

### 1.5 Verify Installations
```bash
docker --version      # Should show Docker version
docker-compose --version  # Should show Docker Compose version
nginx -v              # Should show nginx version
```

---

## ðŸ—„ï¸ Step 2: Database Setup

### 2.1 Install MySQL (if not already installed)
```bash
apt install mysql-server -y
mysql_secure_installation
```

### 2.2 Create Database and User
```bash
mysql -u root -p
```

```sql
CREATE DATABASE Staplewise;
CREATE USER 'staplewise_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON Staplewise.* TO 'staplewise_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 2.3 Update Database Configuration
Update your `.env` file on VPS:
```env
DATABASE_URL="mysql://staplewise_user:your_secure_password@localhost:3306/Staplewise"
```

---

## ðŸ“ Step 3: Deploy Application with Docker

### 3.1 Clone Repository
```bash
cd /var/www
git clone https://github.com/your-username/staplewise.git
cd staplewise
```

### 3.2 Create Production Environment File
```bash
nano .env
```

Add your production environment variables:
```env
# Database Configuration (use external database or uncomment MySQL in docker-compose.yml)
DATABASE_URL="mysql://staplewise_user:your_secure_password@localhost:3306/Staplewise"

# JWT Configuration
JWT_SECRET="your-super-secure-jwt-secret-key-change-this-in-production"

# MinIO Configuration (use external MinIO or uncomment in docker-compose.yml)
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=your_minio_access_key
MINIO_SECRET_KEY=your_minio_secret_key
MINIO_USE_SSL=false
MINIO_BUCKET_DOCUMENTS=staplewise-documents
MINIO_BUCKET_IMAGES=staplewise-images

# Email Configuration
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_gmail_app_password

# Application Configuration
NODE_ENV=production
PORT=3000

# Frontend URL
FRONTEND_URL=https://your-domain.com
```

### 3.3 Build & Run Docker Application
```bash
# Build the Docker image
docker compose build

# Start the application
docker compose up -d

# Check if containers are running
docker compose ps

# View logs
docker compose logs -f app
```

### 3.4 Verify Application is Running
```bash
# Test the application
curl http://localhost:3000/api/health

# Check container status
docker ps
```

---

## ðŸŒ Step 4: Configure Nginx

### 4.1 Create Nginx Configuration
```bash
nano /etc/nginx/sites-available/staplewise
```

Add this configuration:
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # Proxy all requests to Docker container
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Health check
    location /health {
        proxy_pass http://localhost:3000/api/health;
    }
}
```

### 4.2 Enable Site
```bash
ln -s /etc/nginx/sites-available/staplewise /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx
```

---

## ðŸ”’ Step 5: SSL Certificate

### 5.1 Get SSL Certificate
```bash
certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 5.2 Auto-renewal
```bash
crontab -e
```

Add this line:
```
0 12 * * * /usr/bin/certbot renew --quiet
```

---

## ðŸš€ Step 6: Deploy Frontend to Vercel

### 6.1 Prepare Frontend for Production

Update `src/lib/apiClient.ts`:
```typescript
export class ApiClient {
  private static baseUrl = process.env.NODE_ENV === 'production' 
    ? 'https://your-domain.com/api' 
    : 'http://localhost:3000/api';
  // ... rest of the code
}
```

### 6.2 Create Vercel Configuration
Create `vercel.json`:
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ],
  "env": {
    "VITE_API_URL": "https://your-domain.com/api"
  }
}
```

### 6.3 Deploy to Vercel
```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy
vercel --prod
```

---

## ðŸ”§ Step 7: Environment Variables Setup

### 7.1 Vercel Environment Variables
In Vercel dashboard, add these environment variables:
```
VITE_API_URL=https://your-domain.com/api
```

### 7.2 Update Frontend API Client
Update `src/lib/apiClient.ts`:
```typescript
export class ApiClient {
  private static baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';
  // ... rest of the code
}
```

---

## ðŸ§ª Step 8: Testing Production

### 8.1 Test Application
```bash
# Test health endpoint
curl http://your-domain.com/api/health

# Test API endpoints
curl http://your-domain.com/api/auth/login

# Test frontend
curl http://your-domain.com
```

### 8.2 Test Docker Container
```bash
# Check container logs
docker compose logs app

# Restart container if needed
docker compose restart app

# Check container status
docker compose ps
```

### 8.3 Test Frontend & Backend Integration
- Visit your domain: `http://your-domain.com`
- Test login/registration
- Test file uploads
- Test email functionality
- Check browser dev tools â†’ Network tab for API calls

---

## ðŸ”„ Step 9: CI/CD Setup

### 9.1 GitHub Actions for Backend
Create `.github/workflows/deploy-backend.yml`:
```yaml
name: Deploy Backend to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /var/www/staplewise
          git pull origin main
          npm install
          pm2 restart staplewise-backend
```

### 9.2 GitHub Secrets
Add these secrets to your GitHub repository:
- `VPS_HOST`: Your VPS IP
- `VPS_USERNAME`: root
- `VPS_SSH_KEY`: Your SSH private key

---

## ðŸ“Š Step 10: Monitoring & Maintenance

### 10.1 Docker Monitoring
```bash
# View container logs
docker compose logs -f app

# Monitor container resources
docker stats

# View container status
docker compose ps

# Check container health
docker compose exec app curl http://localhost:3000/api/health
```

### 10.2 Nginx Logs
```bash
# Access logs
tail -f /var/log/nginx/access.log

# Error logs
tail -f /var/log/nginx/error.log
```

### 10.3 Application Management
```bash
# Restart application
docker compose restart app

# Update application
git pull
docker compose build
docker compose up -d

# View application logs
docker compose logs app --tail=100
```

### 10.4 Database Backup
Create backup script `/root/backup.sh`:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup"
mkdir -p $BACKUP_DIR

# Database backup (using .my.cnf for credentials)
mysqldump Staplewise > $BACKUP_DIR/staplewise_db_$DATE.sql

# Application backup
tar -czf $BACKUP_DIR/staplewise_app_$DATE.tar.gz /var/www/staplewise

# Keep only last 7 days of backups
find $BACKUP_DIR -name "staplewise_*" -mtime +7 -delete

echo "Backup completed: $DATE"
```

Create MySQL credentials file for automated backups:
```bash
# Create secure credentials file
cat > /root/.my.cnf << 'EOF'
[client]
user=staplewise_user
password=your_secure_mysql_password
EOF

# Secure the credentials file
chmod 600 /root/.my.cnf
```

Make backup script executable:
```bash
chmod +x /root/backup.sh
```

Add to crontab:
```bash
0 2 * * * /root/backup.sh
```

---

## ðŸ³ Docker Alternative (Optional)

If you prefer Docker, here's the setup:

### Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npx", "tsx", "server.ts"]
```

### docker-compose.yml
```yaml
version: '3.8'
services:
  backend:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    depends_on:
      - mysql
      - minio

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: your_root_password
      MYSQL_DATABASE: Staplewise
      MYSQL_USER: staplewise_user
      MYSQL_PASSWORD: your_password
    volumes:
      - mysql_data:/var/lib/mysql

  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: your_minio_user
      MINIO_ROOT_PASSWORD: your_minio_password
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

volumes:
  mysql_data:
  minio_data:
```

---

## ðŸ” Troubleshooting

### Common Issues:

1. **Port 3000 not accessible**
   ```bash
   # Check if container is running
   docker compose ps
   
   # Check container logs
   docker compose logs app
   
   # Check firewall
   ufw status
   ufw allow 3000
   ```

2. **Docker container not starting**
   ```bash
   # Check container logs
   docker compose logs app
   
   # Rebuild and restart
   docker compose down
   docker compose build --no-cache
   docker compose up -d
   ```

3. **Nginx 502 error**
   ```bash
   # Check if container is running
   docker compose ps
   
   # Check nginx error logs
   tail -f /var/log/nginx/error.log
   
   # Test container directly
   curl http://localhost:3000/api/health
   ```

4. **Database connection issues**
   ```bash
   # Test MySQL connection
   mysql -u staplewise_user -p Staplewise
   
   # Check MySQL status
   systemctl status mysql
   
   # Check container environment
   docker compose exec app env | grep DATABASE
   ```

5. **Application not building**
   ```bash
   # Check Docker build logs
   docker compose build --no-cache
   
   # Check for missing files
   ls -la
   
   # Verify .env file exists
   cat .env
   ```

---

## ðŸ“ˆ Performance Optimization

### 1. Enable Gzip Compression
Add to Nginx config:
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

### 2. Enable Caching
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. Database Optimization
```sql
-- Add indexes for better performance
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_product_seller ON products(sellerId);
CREATE INDEX idx_order_buyer ON orders(buyerId);
```

---

## ðŸŽ‰ Success Checklist

- [ ] Docker and Docker Compose installed on VPS
- [ ] Application container running successfully
- [ ] Frontend and backend working together
- [ ] Database connected and working
- [ ] File storage working (MinIO or external)
- [ ] Nginx reverse proxy configured
- [ ] SSL certificate installed
- [ ] Email functionality working
- [ ] Domain pointing to correct server
- [ ] Monitoring and logging setup
- [ ] Backup system configured
- [ ] CI/CD pipeline working (optional)

---

## ðŸ“ž Support

If you encounter any issues:
1. Check the logs: `pm2 logs` and `nginx error logs`
2. Verify environment variables
3. Test individual components
4. Check firewall and port configurations

Your StapleWise application is now production-ready! ðŸš€ 